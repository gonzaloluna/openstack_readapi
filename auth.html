<!DOCTYPE html>

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>OAuth 2 User Agent Authentication Flow Demo</title>

	<link href="https://fonts.googleapis.com/css?family=Lato:100" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-bootgrid/1.3.1/jquery.bootgrid.js"></script>
	<script src="js/jquery.formatDateTime.js"></script>
	<style>
	.searchBox {
		width: 200px;
		display: inline-block;
		margin: 0px 10px;
	}
	input[type="search"] {
		-webkit-appearance: searchfield;
	}
	input[type="search"]::-webkit-search-cancel-button {
		-webkit-appearance: searchfield-cancel-button;
	}
	</style>
</head>

<body>
<div>
    <a class="connect" style="margin: 20px;
    border: 1px solid silver;
    border-radius: 10px;
    padding: 10px;cursor: pointer">Connect</a>
</div>

<div class="authenticated" style="margin: 20px;
    border: 1px solid silver;
    border-radius: 10px;
    padding: 10px;">
    <p>
        <b>Token</b>
        <span class="token">No token, please authenticate by clicking on the Connect button above.</span>
		
		<div>
		Summit <input type="text" id="summit_id" value="current" disabled/>
		Location_id <input type="text" id="location_id" value="131" disabled/>
		</div>
    </p>
	<table id="grid-data"  data-ajax="true"  class="table table-condensed table-hover table-striped" >
		<thead>
			<tr>
				<th data-column-id="id" data-type="numeric"  data-identifier="true">EventID</th>
				<th data-column-id="title" searchable="true">Event Title</th>
				<th data-column-id="speakers" data-formatter="csv">Speakers</th>
				<th data-column-id="youtubeID" >YouTubeID</th>
				<th data-column-id="room" >Room</th>
				<th data-column-id="youtubeID" >YouTubeID</th>
				<th data-column-id="tags" data-formatter="csvtags">Tags</th>
				<th data-column-id="dates" data-formatter="daterange">StartDate-EndDate</th>

			</tr>
		</thead>
	</table>
    
<script type="text/javascript" charset="utf-8">
        $( document ).ready(function() {
		
			// implementation of https://tools.ietf.org/html/rfc6749#section-4.2.1
            var extractToken = function(hash) {
                var match = hash.match(/access_token=([\w\d\.\-\_\~\%]+)/);
                return !!match && match[1];
            };
			
            var setting =
            {
                'host': "testopenstackid.openstack.org",
				'rserver_host': "testresource-server.openstack.org",
                'clientId':"-0-JX34ftzKBVf9kMq9azqOcuK5UFsQR.openstack.client",
				'scopes' : 'https://testresource-server.openstack.org/summits/read https://testresource-server.openstack.org/summits/write-videos'
            };

			var summit_id = $("#summit_id").val();
			var location_id = $("#location_id").val();
            var authHost     = "https://" + setting.host;
            //var resourceHost1 = "https://"+setting.rserver_host+'/api/v1/summits/'+ summit_id + '/locations/' + location_id + '/events/published';
			var resourceHost1 = "https://"+setting.rserver_host+'/api/v1/summits/'+ summit_id + '/locations/' + location_id + '/events/published';
				//resourceHost1 = "https://"+setting.rserver_host+'/api/v1/summits/' + summit_id + '/events/published';
			var resourceHost2 = "https://"+setting.rserver_host+'/api/v1/summits/';
			var resourceHost3 = "https://"+setting.rserver_host+'/api/v1/marketplace/private-clouds';
			var resourceHost4 = "https://"+setting.rserver_host+'/api/v1/marketplace/consultants';

            var endUserAuthorizationEndpoint = authHost + "/oauth2/auth";

            var token = extractToken(document.location.hash);

            if (token) {

                $('div.authenticated').show();

                $('span.token').text(token);
				
				$("#grid-data").bootgrid({
					ajax: true,
					ajaxSettings: {
						method: "GET",
						cache: false,
						beforeSend: function (xhr) {
							xhr.setRequestHeader ("Authorization", "Bearer " + unescape(token));
							xhr.setRequestHeader('Accept', "application/json");
							xhr.setRequestHeader('Content-Type', 'text/plain');
						}
					},
					url: resourceHost1,
					requestHandler:function (request) { 
							var title = $('#tb_title').val().length ? 'title=@' + $('#tb_title').val().trim() : '';
							var keyword = $('#tb_keyword').val().length ? 'tags=@' + $('#tb_keyword').val().trim() : '';
							var filters =  (title.length && keyword.length ? [ title , keyword ] : keyword+ '' + title);
							var isSorted = (request.sort);
							var orderBy = '';
							if(isSorted){
								var order = Object.keys(request.sort)[0];
								var asc = request.sort[Object.keys(request.sort)[0]];
								orderBy = order + '' + (asc === 'asc' ?  '+' : '-');
								
								var request = {
									filter : filters,
									page: request.current, 
									per_page: request.rowCount,
									order: orderBy,
								};
							}else{
								var request = {
									filter : filters,
									page: request.current, 
									per_page: request.rowCount
								};
							}
							return request; 
						},
					responseHandler:function (response) { 
						var response = {
							current: response.current_page,
							rowCount: response.per_page,
							rows: response.data,
							total: response.total
						};

						return response; 
				
					},
					 formatters: {
						csv: function (column, row){
							if(row[column.id]){
								return row[column.id].join(","); 
							}else{
								return "";
							}
						},
						csvtags: function (column, row){
							if(row[column.id]){
								var arr = jQuery.map( $(row['tags']), function( tag ) {
								   return tag.tag;
								});
								return arr.join(","); 
							}else{
								return "";
							}
						},
						daterange: function(column, row){
							var utcEnd_date = row.end_date;
							var utcStart_date = row.start_date;
							var startDate = new Date(0); // The 0 there is the key, which sets the date to the epoch
							var endDate = new Date(0); 
							startDate.setUTCSeconds(utcStart_date);
							endDate.setUTCSeconds(utcEnd_date);
							return $.formatDateTime("mm/dd/yy",startDate) +"-"+$.formatDateTime("mm/dd/yy",endDate);
						}
					},
					rowCount: [5, 10, 25, 50, 100],
					templates: {
						header: "<div id=\"{{ctx.id}}\" class=\"{{css.header}}\"><div class=\"row\"><div class=\"col-sm-12 actionBar\"><input type='search' class='search-field form-control searchBox' id='tb_keyword' placeholder='keyword'><input type='search' class='search-field form-control searchBox' placeholder='Title' id='tb_title'><input type='search' class='search-field form-control searchBox' placeholder='Room' id='tb_room'><p class=\"{{css.actions}}\"></p></div></div></div>"    
					}
				}).on("loaded.rs.jquery.bootgrid", function(){   			
					$('[data-toggle="tooltip"]').tooltip();
				});
           
 
            } else {
                $('div.authenticate').show();

                var authUrl = endUserAuthorizationEndpoint +
                        "?response_type=token id_token" +
                        "&approval_prompt=force"+
                        "&scope=" + encodeURI(setting.scopes)+
                        "&client_id="  + encodeURI(setting.clientId) +
                        "&state=123456" +
						"&nonce=123456" +
						"&display=page" +
						"&login_hint=gnl.luna@gmail.com"+	
                        "&redirect_uri=" + window.location;

                $("a.connect").attr("href", authUrl);
			}
        });
    </script>

</div>
</body>
</html>
